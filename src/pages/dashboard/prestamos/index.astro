---
import Button1 from "../../../components/atomos/Button1.astro";
import Titulo1 from "../../../components/atomos/Titulo1.astro";
import ContenedorBoton from "../../../components/moleculas/ContenedorBoton.astro";
import ContenedorInputForm from "../../../components/moleculas/ContenedorInputForm.astro";
import FormularioDeBusqueda from "../../../components/organismos/FormularioDeBusqueda";
import MainDash from "../../../components/organismos/MainDash.astro";
import Layoutdash from "../layouts/Layoutdash.astro";
import FormularioPrestamo from "./FormularioPrestamo.astro";
import PrestamoGenerado from "./PrestamoGenerado.astro";

import { eq, User, db, Cliente } from "astro:db";
const userId = "123456";
const clientes = await db
  .select()
  .from(Cliente)
  .where(eq(Cliente.usuarioId, userId));
---

<Layoutdash title="Prestamos">
  <MainDash>
    <div class="flex w-full p-5 flex-col items-start justify-start">
      <div class="flex mb-2 items-center justify-between w-full gap-5">
        <Titulo1>Prestamos</Titulo1>
        <FormularioDeBusqueda clientes={clientes} client:load />
      </div>
      <div class="w-full flex items-start">
        <FormularioPrestamo />
      </div>
    </div>
    <div
      class="flex w-2/6 p-5 flex-col items- bg-primary-300/40 rounded-lg justify-start"
    >
      <Titulo1>Prestamo Generado</Titulo1>

      <PrestamoGenerado />

      <ContenedorBoton>
        <Button1 id="cargarPrestamo">Confirmar</Button1>
        <Button1 id="limpiarSimulador">limpiar</Button1>
      </ContenedorBoton>
    </div>
  </MainDash>
</Layoutdash>

<script>
  import { busqueda, prestamoSimulado } from "../../../context/store";

  document.getElementById("limpiarSimulador").addEventListener("click", () => {
    prestamoSimulado.set({
      usuarioId: "",
      clienteId: "",
      importeCuota: 0,
      montoTotal: 0,
      interesGenerado: 0,
      tasaInteres: 0,
      nCuotas: 0,
    });
  });
</script>
<script>
  import { prestamoSimulado } from "../../../context/store";

  const formulario = document.getElementById(
    "prestamoGenerado"
  ) as HTMLFormElement;

  const formData = new FormData(formulario);
  document
    .getElementById("cargarPrestamo")
    .addEventListener("click", async (e) => {
      const contextoPrestamo = prestamoSimulado.get();

      try {
        const res = await fetch("/api/prestamos/setPrest", {
          method: "POST",
          body: JSON.stringify({
            contextoPrestamo,
          }),
        });
        if (res.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.log(error);
      }
    });
</script>
